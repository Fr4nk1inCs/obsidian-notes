#计算机 #底层 #硬件

# 引言
略

# 计算机体系结构中的 8 个伟大思想
## 面向摩尔定律的设计
英特尔创始人之一戈登 · 摩尔的经验之谈, 其核心内容为: 集成电路上可以容纳的晶体管数目在大约每经过 18 个月便会增加一倍

## 使用抽象简化设计
隐藏低层次细节，为高层次提供更简单的模型

## 加速经常性事件
通过实验及测量确定经常性事件

## 通过并行提高性能

## 通过流水线 (pipelining) 提高性能

## 通过预测提高性能

## 存储层次

## 通过冗余提高可靠性

# 程序表象之下
- 应用软件
	- 用高级语言编写
- 系统软件
	- 编译器: 把高级语言编写的程序翻译成硬件能执行的指令
	- 操作系统
		- 处理基本的 I/O 操作
		- 分配外存和内存
		- 为多个应用程序提供共享计算机资源的服务
- 硬件
	- 处理器
	- 存储
	- I/O 控制器

## 从高级语言到硬件语言
- 高级语言程序 (C 语言)
	```c
	swap(size_t v[], size_t k)
	{
		size_t temp;
		temp = v[k];
		v[k] = v[k+1];
		v[k+1] = temp;
	}
	```
- 经编译器翻译为汇编语言程序 (RISC-V 指令系统)
	```riscvasm
	swap:
		slli x6, x11, 3
		add  x6, x10, x6
		ld   x5, 0(x6)
		ld   x7, 8(x6)
		sd   x7, 0(x6)
		sd   x5, 8(x6)
		jalr x0, 0(x1)
	```
-  经汇编器翻译为二进制机器语言程序 (RISC-V 指令系统)
	```bin
	00000000001101011001001100010011
	00000000011001010000001100110011
	00000000000000110011001010000011
	00000000100000110011001110000011
	00000000011100110011000000100011
	00000000010100110011010000100011
	00000000000000001000000001100111
	```

# 箱盖后的硬件
- 输入设备
- 输出设备
- 存储器
- 控制器
- 运算器

# 处理器和存储制造技术
ingot (硅锭) → wafer (晶圆) → die (晶片) → chip (芯片)
![[1.jpg]]

集成电路的成本
- 与面积和缺陷率并不呈线性关系
- 公式 1: 直接导出 $$\text{每晶片的价格}=\frac{\text{每晶圆的价格}}{\text{每晶圆的晶片数}\times\text{良率}}$$
- 公式 2: 近似$$\text{每晶圆的晶片数}\approx\frac{\text{晶圆面积}}{\text{晶片面积}}$$
- 公式 3: 经验公式$$\text{工艺良率}=\frac{1}{\left(1+\displaystyle\frac{\text{单位面积的缺陷数}\times\text{芯片面积}}{2}\right)^2}$$

# 性能
## 衡量标准 / 定义
- **响应时间** / 执行时间
	- 从开始一个任务到该任务完成的时间
- **吞吐率** / **带宽**
	- 在给定时间内完成的任务数

> 个人电脑更关注响应时间, 服务器更关注吞吐率.

前几章主要考虑响应时间
- 我们可将性能和响应时间之间的关系表示为$$\text{性能}_X=\frac{1}{\text{执行时间}_X}$$
- X 的性能是 Y 的 n 倍$$\frac{\text{性能}_X}{\text{性能}_Y}=\frac{\text{执行时间}_Y}{\text{执行时间}_X}=n$$

## 性能的度量 : 时间
- 运行时间 (elapsed time)
	- 又叫挂钟时间 (wall clock time) / 响应时间 (response time)
- CPU 时间 (CPU 执行时间, CPU execution time)
	- 只表示在 CPU 上花费的时间, 不包括等待 I/O 或运行其他程序的时间
	- 用户 CPU 时间 (user CPU time): 程序本身所花费的 CPU 时间
	- 系统 CPU 时间 (system CPU time): 为执行程序而花费在操作系统上的时间
	- CPU 时间 = 用户 CPU 时间 + 系统 CPU 时间

> 用户感受到的是程序的运行时间, 而不是 CPU 时间

- CPU 时钟
	- 时钟周期 (clock cycle)
	- 时钟频率 (clock rate/speed)

$$\text{时钟频率} = \frac{1\mathrm{s}}{\text{时钟周期长度}}$$

## CPU 性能及其影响因素
$$\text{CPU 时间}=\text{CPU 时钟周期数}\times\text{时钟周期长度}=\frac{\text{CPU 时钟周期数}}{\text{时钟频率}}$$
- 减少 CPU 时间的相关参数
	- 减少时钟周期数
	- 增加时钟频率

> 硬件设计者需在时钟频率和时钟周期数之间权衡

## 指令性能
$$
\text{CPU 时钟周期数} = \text{程序指令数} \times \text{CPI}\\
$$
- 指令平均时钟周期数 (clock per instruction, CPI)
	- 由 CPU 的硬件结构决定
	- 如果不同指令有不同的 CPI ，则需要考虑平均 CPI
- 程序指令数 (Instruction Count) 的影响因素
	- 程序本身
	- 指令集架构 (instruction set architecture, ISA)
	- 编译器
## 经典的 CPU 性能公式
$$
\text{CPU 时间} = \text{指令数}\times \text{CPI}\times \text{时钟周期长度}=\frac{\text{指令数}\times \text{CPI}}{\text{时钟频率}}
$$

|     软硬件指标     | 影响什么              |
|:------------------:|:---------------------:|
|        算法        | 指令数, CPI           |
|      编程语言      | 指令数, CPI           |
|       编译器       | 指令数, CPI           |
| 指令系统, 体系结构 | 指令数, 时钟频率, CPI |
# 功耗墙
每个晶体管所需要的功耗
$$
\text{功耗}\varpropto \frac{1}{2}\times \text{负载电容}\times\text{工作电压}^2\times\text{开关频率}
$$
开关 (0→1→0 / 1→0→1) 频率是时钟频率的函数, 负载电容是连接到输出上的晶体管数量 (扇出) 和工艺的函数.

> 降低功耗主要依靠降低电压 (工艺提升) 实现

- 难题
	- 无法继续降低电压, 电压降低将导致漏电流增大
	- 缺乏有效的降温手段

# 沧海巨变 : 从单处理器到多处理器
- 多处理器
	- 每个芯片有多个处理器
	- 需要显式并行编程
		- 与指令级并行性比较
		- 硬件一次执行多条指令
		- 对程序员隐藏
	- 难点
		- 高性能编程
		- 负载平衡
		- 优化通信和同步

# 实例 : 测评 Intel Core i7
略

# 谬误与陷阱
- 谬误 1. 低利用率的计算机具有更低功耗
- 谬误 2. 面向性能的设计和面向能效的设计具有不相关的目标
- 陷阱 1. 在改进计算机的某个方面时, 期望总性能的提高与改进大小成正比$$\text{Amdahl 定律:}\quad \text{改进后的执行时间}=\frac{\text{受改进影响的执行时间}}{\text{改进量}}+\text{不受影响的执行时间}$$
- 陷阱 2. 用性能公式的一个子集去度量性能
	- MIPS: 每秒百万条指令数 $$\text{MIPS}=\frac{\text{指令数}}{\text{执行时间}\times10^6}=\frac{\text{时钟频率}}{\text{CPI}\times 10^6}$$
	> 不同的程序有不同的 MIPS 