#计算机 #RISC-V
# RISC-V 指令集
| 类别       | 指令                     | 示例                | 含义                          | 注释                                                      |
| ---------- | ------------------------ | ------------------- | ----------------------------- | --------------------------------------------------------- |
| 算术运算   | 加                       | `add x5, x6, x7`    | `x5 = x6 + x7`                | 三寄存器操作数; 加                                        |
| 算术运算   | 减                       | `sub x5, x6, x7`    | `x5 = x6 - x7`                | 三寄存器操作数; 减                                        |
| 算术运算   | 立即数加                 | `addi x5, x6, 20`   | `x5 = x6 + 20`                | 用于加常数                                                |
| 数据传输   | 取双字 (RV64I)           | `ld x5, 40(x6)`     | `x5 = Memory[x6 + 40]`        | 从存储器取双字到寄存器                                    |
| 数据传输   | 存双字 (RV64I)           | `sd x5, 40(x6)`     | `Memory[x6 + 40] = x5`        | 从寄存器存双字到寄存器                                    |
| 数据传输   | 取字                     | `lw x5, 40(x6)`     | `x5 = Memory[x6 + 40]`        | 从存储器取字到寄存器                                      |
| 数据传输   | 取字 (无符号数)          | `lwu x5, 40(x6)`    | `x5 = Memory[x6 + 40]`        | 从存储器取无符号字到寄存器                                |
| 数据传输   | 存字                     | `sw x5, 40(x6)`     | `Memory[x6 + 40] = x5`        | 从寄存器存字到寄存器                                      |
| 数据传输   | 取半字                   | `lh x5, 40(x6)`     | `x5 = Memory[x6 + 40]`        | 从存储器取半字到寄存器                                    |
| 数据传输   | 取半字 (无符号数)        | `lhu x5, 40(x6)`    | `x5 = Memory[x6 + 40]`        | 从存储器取无符号半字到寄存器                              |
| 数据传输   | 存半字                   | `sh x5, 40(x6)`     | `Memory[x6 + 40] = x5`        | 从寄存器存半字到寄存器                                    |
| 数据传输   | 取字节                   | `lb x5, 40(x6)`     | `x5 = Memory[x6 + 40]`        | 从存储器取字节到寄存器                                    |
| 数据传输   | 取字节 (无符号数)        | `lbu x5, 40(x6)`    | `x5 = Memory[x6 + 40]`        | 从存储器取无符号字节到寄存器                              |
| 数据传输   | 存字节                   | `sb x5, 40(x6)`     | `Memory[x6 + 40] = x5`        | 从寄存器存字节到寄存器                                    |
| 数据传输   | 取保留字                 | `lr.d x5, (x6)`     | `x5 = Memory[x6]`             | 取; 原子交换的前半部分                                    |
| 数据操作   | 存条件字                 | `sc.d x7, x5, (x6)` | `Memory[x6] = x5; x7 = 0/1`   | 存; 原子交换的后半部分                                    |
| 数据传输   | 取立即数高位             | `lui x5, 0x12345`   | `x5 = 0x12345000`             | 取右移 12 位后的 20 位立即数                              |
| 逻辑运算   | 与                       | `and x5, x6, x7`    | `x5 = x6 & x7`                | 三寄存器操作数; 按位与                                    |
| 逻辑运算   | 或                       | `or x5, x6, x8`     | `x5 = x6 \| x8`               | 三寄存器操作数; 按位或                                    |
| 逻辑运算   | 异或                     | `xor x5, x6, x9`    | `x5 = x6 ^ x9`                | 三寄存器操作数; 按位异或                                  |
| 逻辑运算   | 与立即数                 | `andi x5, x6, 20`   | `x5 = x6 & 20`                | 寄存器与常数按位与                                        |
| 逻辑运算   | 或立即数                 | `ori x5, x6, 20`    | `x5 = x6 \| 20`               | 寄存器与常数按位或                                        |
| 逻辑运算   | 异或立即数               | `xori x5, x6, 20`   | `x5 = x6 ^ 20`                | 寄存器与常数按位异或                                      |
| 移位操作   | 逻辑左移                 | `sll x5, x6, x7`    | `x5 = x6 << x7`               | 按寄存器给定位数左移                                      |
| 移位操作   | 逻辑右移                 | `srl x5, x6, x7`    | `x5 = x6 >> x7`               | 按寄存器给定位数右移                                      |
| 移位操作   | 算术右移                 | `sla x5, x6, x7`    | `x5 = x6 >> x7`               | 按寄存器给定位数算术右移                                  |
| 移位操作   | 逻辑左移立即数           | `slli x5, x6, 3`    | `x5 = x6 << 3`                | 按立即数给定位数左移                                      |
| 移位操作   | 逻辑右移立即数           | `srli x5, x6, 3`    | `x5 = x6 >> 3`                | 按立即数给定位数右移                                      |
| 移位操作   | 算术右移立即数           | `slai x5, x6, 3`    | `x5 = x6 >> 3`                | 按立即数给定位数算术右移                                  |
| 条件分支   | 相等即跳转               | `beq x5, x6, 100`   | `if (x5 == x6) goto PC + 100` | 若寄存器数值相等则跳转到 PC 相对地址                      |
| 条件分支   | 不等即跳转               | `bne x5, x6, 100`   | `if (x5 != x6) goto PC + 100` | 若寄存器数值不等则跳转到 PC 相对地址                      |
| 条件分支   | 小于即跳转               | `blt x5, x6, 100`   | `if (x5 < x6) goto PC + 100`  | 若寄存器数值比较结果小于则跳转到 PC 相对地址              |
| 条件分支   | 大于等于即跳转           | `bge x5, x6, 100`   | `if (x5 >= x6) goto PC + 100` | 若寄存器数值比较结果大于等于则跳转到 PC 相对地址          |
| 条件分支   | 小于即跳转 (无符号)      | `bltu x5, x6, 100`  | `if (x5 < x6) goto PC + 100`  | 若寄存器数值比较结果小于则跳转到 PC 相对地址 (无符号)     |
| 条件分支   | 大于等于即跳转 (无符号)  | `bgeu x5, x6, 100`  | `if (x5 >= x6) goto PC + 100` | 若寄存器数值比较结果大于等于则跳转到 PC 相对地址 (无符号) |
| 无条件跳转 | 跳转 - 链接              | `jal x1, 100`       | `x1 = PC + 4; goto PC + 100`  | 用于 PC 相关的过程调用                                    |
| 无条件跳转 | 跳转 - 链接 (寄存器地址) | `jalr x1, 100(x5)`  | `x1 = PC + 4; goto x5 + 100`  | 用于过程返回; 非直接调用                                  |

# 寄存器约定
![[Pasted image 20220322144629.png|600]]

| 寄存器        | ABI名        | 作用            | 英文                             | 保存者 |
| ------------- | ------------ | --------------- | -------------------------------- | ------ |
| `x0`          | `zero`       | 常数 0          | constant 0                       |        |
| `x1`          | `ra`         | 返回地址        | return address                   | caller |
| `x2`          | `sp`         | 栈指针          | stack pointer                    | callee |
| `x3`          | `gp`         | 全局指针        | global pointer                   |        |
| `x4`          | `tp`         | 线程指针        | thread pointer                   |        |
| `x5` - `x7`   | `t0` - `t2`  | 临时寄存器      | temporaries                      | caller |
| `x8`          | `s0`/`fp`    | 栈帧指针        | frame pointer                    | callee |
| `x9`          | `s1`         | 保存寄存器      | saved register                   | callee |
| `x10` - `x11` | `a0` - `a1`  | 函数参数/返回值 | function arguments/return values | caller |
| `x12` - `17`  | `a2` - `a7`  | 函数参数        | function arguments               | caller |
| `x18` - `x27` | `s2` - `s11` | 保存寄存器      | saved register                   | callee |
| `x28` - `x31` | `t3` - `t6`  | 临时寄存器      | temporaries                      | caller |

# RV32I 指令格式
[[chap-2-指令#^1f45d3|指令格式]]

[[chap-2-指令#^c68e3c|字段命名]]
### R-type

|  指令  |  funct7   | rs2 | rs1 | funct3 | rd  |  opcode   |
|:------:|:---------:|:---:|:---:|:------:|:---:|:---------:|
| `add`  | `0000000` | reg | reg | `000`  | rd  | `0110011` |
| `sub`  | `0100000` | reg | reg | `000`  | rd  | `0110011` |
| `sll`  | `0000000` | reg | reg | `001`  | rd  | `0110011` |
| `slt`  | `0000000` | reg | reg | `010`  | rd  | `0110011` |
| `sltu` | `0000000` | reg | reg | `011`  | rd  | `0110011` |
| `xor`  | `0000000` | reg | reg | `100`  | rd  | `0110011` |
| `srl`  | `0000000` | reg | reg | `101`  | rd  | `0110011` |
| `sra`  | `0100000` | reg | reg | `101`  | rd  | `0110011` |
|  `or`  | `0000000` | reg | reg | `110`  | rd  | `0110011` |
| `and`  | `0000000` | reg | reg | `111`  | rd  | `0110011` |

^7e851f

### I-type

|  指令  | offset\[11:0\] | rs1 | funct3 | rd  |  opcode   |
|:------:|:--------------:|:---:|:------:|:---:|:---------:|
| `jalr` | offset\[11:0\] | reg | `000`  | reg | `1100111` |
|  `lb`  | offset\[11:0\] | reg | `000`  | reg | `0000011` |
|  `lh`  | offset\[11:0\] | reg | `001`  | reg | `0000011` |
|  `lw`  | offset\[11:0\] | reg | `010`  | reg | `0000011` |
| `lbu`  | offset\[11:0\] | reg | `100`  | reg | `0000011` |
| `lhu`  | offset\[11:0\] | reg | `101`  | reg | `0000011` |

^7fdca2

|  指令   | immediate\[11:0\] | rs1 | funct3 | rd  |  opcode   |
|:-------:|:-----------------:|:---:|:------:|:---:|:---------:|
| `addi`  | immediate\[11:0\] | reg | `000`  | reg | `0010011` |
| `slti`  | immediate\[11:0\] | reg | `010`  | reg | `0010011` |
| `sltui` | immediate\[11:0\] | reg | `011`  | reg | `0010011` |
| `xori`  | immediate\[11:0\] | reg | `100`  | reg | `0010011` |
|  `ori`  | immediate\[11:0\] | reg | `110`  | reg | `0010011` |
| `andi`  | immediate\[11:0\] | reg | `111`  | reg | `0010011` |

^046c68

|  指令  |  funct7   | immediate\[4:0\] | rs1 | funct3 | rd  |  opcode   |
|:------:|:---------:|:----------------:|:---:|:------:|:---:|:---------:|
| `slli` | `0000000` |   shamt\[4:0\]   | reg | `001`  | reg | `0010011` |
| `srli` | `0000000` |   shamt\[4:0\]   | reg | `101`  | reg | `0010011` |
| `srai` | `0100000` |   shamt\[4:0\]   | reg | `101`  | reg | `0010011` |

^36ca7b

### S-type
| 指令 | offset\[11:5\] | rs2 | rs1 | funct3 | offset\[4:0\] |  opcode   |
|:----:|:--------------:|:---:|:---:|:------:|:-------------:|:---------:|
| `sb` | offset\[11:5\] | reg | reg | `000`  | offset\[4:0\] | `0100011` |
| `sh` | offset\[11:5\] | reg | reg | `001`  | offset\[4:0\] | `0100011` |
| `sw` | offset\[11:5\] | reg | reg | `010`  | offset\[4:0\] | `0100011` |

^873030

 
### B-type
|  指令  | offset\[12\|10:5\] | rs2 | rs1 | funct3 | offset\[4:1\|11\] |  opcode   |
|:------:|:------------------:|:---:|:---:|:------:|:-----------------:|:---------:|
| `beq`  | offset\[12\|10:5\] | reg | reg | `000`  | offset\[4:1\|11\] | `1100011` |
| `bne`  | offset\[12\|10:5\] | reg | reg | `001`  | offset\[4:1\|11\] | `1100011` |
| `blt`  | offset\[12\|10:5\] | reg | reg | `100`  | offset\[4:1\|11\] | `1100011` | 
| `bge`  | offset\[12\|10:5\] | reg | reg | `101`  | offset\[4:1\|11\] | `1100011` |
| `bltu` | offset\[12\|10:5\] | reg | reg | `110`  | offset\[4:1\|11\] | `1100011` |
| `bgeu` | offset\[12\|10:5\] | reg | reg | `111`  | offset\[4:1\|11\] | `1100011` |

### J-type
| 指令  | offset\[20\|10:0\|11\|19:12\] | rd  |  opcode   |
|:-----:|:-----------------------------:|:---:|:---------:|
| `jal` | offset\[20\|10:0\|11\|19:12\] | reg | `1101111` |

### U-type
|  指令   | immediate\[31:12\] | rd  |  opcode   |
|:-------:|:------------------:|:---:|:---------:|
|  `lui`  | immediate\[31:12\] | reg | `0110111` |
| `auipc` | immediate\[31:12\] | reg | `0010111` |